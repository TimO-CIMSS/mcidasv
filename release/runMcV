#!/bin/sh

# Change to the directory that the script resides in before executing
dirname=`dirname "$0"`
cd "$dirname"

# Always run the default prefs; user can override as much as they want
. ./runMcV.prefs

# Create .mcidasv directory if it doesn't already exist
if [ ! -d ${HOME}/.mcidasv ]; then
	mkdir ${HOME}/.mcidasv
fi

# Copy prefs to .mcidasv directory if it doesn't already exist
if [ ! -f ${HOME}/.mcidasv/runMcV.prefs ]; then
	cp runMcV.prefs ${HOME}/.mcidasv/runMcV.prefs
fi

# If .mcidas/runMcV.prefs exists, source it to populate the current environment
if [ -f ${HOME}/.mcidasv/runMcV.prefs ]; then
	. ${HOME}/.mcidasv/runMcV.prefs
fi

if [ "${USE_3DSTUFF}" -eq 1 ]; then
	IDV_3D="true"
else
	IDV_3D="false"
fi

# gather up previously set values.
JAVA_FLAGS="-Xmx${HEAP_SIZE} ${INIT_HEAP} ${THREAD_STACK} ${YOUNG_GEN}"
MCV_FLAGS="${COLLAB_MODE} ${COLLAB_PORT} ${ENABLE_DEBUG} -Didv.3d=${IDV_3D}"

################################################################################
# OS specific settings

# Mac OS X settings
if [ `uname -s` = "Darwin" ]; then

	# Look for the Java3D/JOGL package
	XBOOTCLASSPATH=
	if [ -d "java3d" ]; then
		JAVA3D_LIB=${PWD}/java3d
		JAVA3D_CP=${JAVA3D_LIB}/j3dcore.jar:${JAVA3D_LIB}/j3dutils.jar:${JAVA3D_LIB}/vecmath.jar
		XBOOTCLASSPATH=-Xbootclasspath/p:${JAVA3D_CP}
		if [ -d "jogl" -a "${JOGL_TOGL}" -eq 1 ]; then
			JOGL_LIB=${PWD}/jogl
			JOGL_CP=${JOGL_LIB}:${JOGL_LIB}/jogl.jar:${JOGL_LIB}/gluegen-rt.jar
			export DYLD_LIBRARY_PATH=${JOGL_LIB}
			XBOOTCLASSPATH=-Xbootclasspath/p:${JOGL_CP}:${JAVA3D_CP}
		fi
	fi
	
	# If we are on Leopard:
	# Use aqua look & feel to get rid of lightweight/heavyweight 3D overlay problems
	# Get rid of any XBOOTCLASSPATH business and just use system Java3D
	LEOPARD_TEST=`sw_vers | grep 10.5`
	if [ "${LEOPARD_TEST}" != "" ]; then
	    MCV_FLAGS="${MCV_FLAGS} -forceaqua"
	    XBOOTCLASSPATH=
	fi
	
	# Build JAVA_FLAGS and set the dock/menu bar name
	JAVA_FLAGS="${JAVA_FLAGS} ${XBOOTCLASSPATH} -Xdock:name=McIDAS-V -Xdock:icon=mcidasv.icns"
	
fi
# Done with Mac OS X settings

# Done with OS specific settings
################################################################################

# Set the command name
command="java ${JAVA_FLAGS} -cp idv.jar -jar mcidasv.jar ${MCV_FLAGS} $*"

# Look for java
if [ -f "./jre/bin/java" ]; then
	# We are in the installer directory
	./jre/bin/${command}
else
	if [ -n "${JAVA_HOME}" ]; then
		# Try using JAVA_HOME
		${JAVA_HOME}/bin/${command}
	else 
		# Try just using java
		${command}
	fi
fi
